# SPDX-FileCopyrightText: 2023 KOINSLOT, Inc.
#
# SPDX-License-Identifier: GPL-3.0-or-later

name: Test Espressif Component
on:
  workflow_call:
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: check out repository
      uses: actions/checkout@v3
    - name: get apps to build
      id: apps
      run: |
        echo "Found apps:"
        find . | grep 'main/idf_component.yml' | xargs -n 1 dirname | xargs -n 1 dirname | xargs -n 1 echo "  -"
        echo "apps=$(find . | grep 'main/idf_component.yml' | xargs -n 1 dirname | xargs -n 1 dirname | xargs echo)" >> "$GITHUB_OUTPUT"
    - name: cache build files
      uses: actions/cache@v3
      with:
        key: ${{ github.repository }}/${{ github.sha }}/build
        path: ~/**/build
    - name: build apps
      run: |
        for project_dir in ${{ steps.apps.outputs.apps }}; do
          docker run -v $PWD:$PWD -w $PWD -e SDKCONFIG_DEFAULTS='sdkconfig.ci' kywy/devkit:latest idf.py --project-dir $project_dir build
        done
    - name: test component
      run: docker run -v $PWD:$PWD -w $PWD kywy/devkit:latest test
